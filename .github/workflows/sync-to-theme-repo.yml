name: Sync to Theme Repository

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´çš„æäº¤å†å²
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
    - name: Clean posts directory and remove workflow files
      run: |
        # è¿›å…¥postsç›®å½•
        cd src/content/posts
        
        # åˆ é™¤é™¤äº†markdown.mdä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶
        find . -type f -name "*.md" ! -name "markdown.md" -delete
        
        # æ˜¾ç¤ºå‰©ä½™æ–‡ä»¶
        echo "Remaining files in posts directory:"
        ls -la
        
        # è¿”å›é¡¹ç›®æ ¹ç›®å½•
        cd ../../..
        
        # åˆ é™¤æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶
        if [ -d ".github" ]; then
          echo "Removing .github directory..."
          rm -rf .github
          echo "âœ… .github directory removed"
        else
          echo "No .github directory found"
        fi
        
    - name: Commit changes if any
      run: |
        git add .
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Clean posts directory and remove workflows for theme sync"
        fi
        
    - name: Check if target repository exists and push
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        # æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†PAT_TOKEN
        if [ -z "$PAT_TOKEN" ]; then
          echo "âŒ PAT_TOKEN secret not found!"
          echo "Please create a Personal Access Token and add it as PAT_TOKEN secret"
          echo "Token needs 'repo' permissions to push to the target repository"
          exit 1
        fi
        
        # è®¾ç½®ç›®æ ‡ä»“åº“URL
        TARGET_REPO="https://github.com/fishcpy/astro-theme-fishcpy.git"
        
        # æ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦å­˜åœ¨
        echo "ğŸ” Checking if target repository exists..."
        if curl -s -H "Authorization: token $PAT_TOKEN" \
           "https://api.github.com/repos/fishcpy/astro-theme-fishcpy" | grep -q '"name"'; then
          echo "âœ… Target repository exists"
        else
          echo "âŒ Target repository does not exist!"
          echo "Please create the repository: https://github.com/fishcpy/astro-theme-fishcpy"
          echo "Or check if the repository name is correct"
          exit 1
        fi
        
        # æ·»åŠ è¿œç¨‹ä»“åº“
        git remote add theme-repo https://x-access-token:$PAT_TOKEN@github.com/fishcpy/astro-theme-fishcpy.git
        
        # æ¨é€åˆ°ç›®æ ‡ä»“åº“
        echo "ğŸš€ Pushing to target repository..."
        git push theme-repo main --force-with-lease
        
    - name: Summary
      run: |
        echo "âœ… Successfully synced to theme repository"
        echo "ğŸ—‘ï¸  Cleaned posts directory (kept only markdown.md)"
        echo "ğŸ—‘ï¸  Removed all workflow files (.github directory)"
        echo "ğŸ“ Updated banner.enable to true"
        echo "ğŸ”„ Pushed with commit history to https://github.com/fishcpy/astro-theme-fishcpy.git"
        echo ""
        echo "ğŸ“‹ Setup Instructions (if this was your first run):"
        echo "1. Create Personal Access Token: https://github.com/settings/tokens"
        echo "2. Add token as PAT_TOKEN secret in repository settings"
        echo "3. Ensure target repository exists: https://github.com/fishcpy/astro-theme-fishcpy"