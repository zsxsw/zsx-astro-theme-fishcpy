---
export interface Props {
	content: string;
	class?: string;
}

const { content, class: className } = Astro.props;

// å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œä¸æ¸²æŸ“ç»„ä»¶
if (!content || content.trim() === "") {
	return null;
}
---

{content && (
  <div class:list={["ai-summary", className]}>
    <div class="ai-title">
      <div class="ai-title-left">
        <i>ğŸ¤–</i>
        <span class="ai-title-text">AI æ‘˜è¦</span>
      </div>
      <div class="ai-tag">fishcpy AI</div>
    </div>
    <div class="ai-explanation" data-content={content}></div>
  </div>
)}

<script>
  // æ£€æŸ¥å½“å‰é¡µé¢è·¯å¾„æ˜¯å¦åŒ…å« "posts"
  function isPostsPage() {
    return window.location.pathname.includes('/posts/');
  }

  // å…¨å±€å‡½æ•°ï¼Œç”¨äºåˆå§‹åŒ–AIæ‰“å­—æ•ˆæœ
  function initAITyping() {
    // åªåœ¨åŒ…å« "posts" çš„é¡µé¢æ‰æ‰§è¡ŒAIæ€»ç»“åŠŸèƒ½
    if (!isPostsPage()) {
      return;
    }

    // æŸ¥æ‰¾æ‰€æœ‰AIæ‘˜è¦å®¹å™¨
    const aiSummaryContainers = document.querySelectorAll('.ai-summary');
    
    aiSummaryContainers.forEach(container => {
      const textElement = container.querySelector('.ai-explanation');
      
      if (!textElement) {
        return;
      }

      // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
      if (textElement.hasAttribute('data-initialized')) {
        return;
      }

      const content = textElement.getAttribute('data-content');
      if (!content) {
        return;
      }

      // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
      textElement.setAttribute('data-initialized', 'true');
      
      // æ¸…ç©ºæ–‡æœ¬å†…å®¹ï¼Œå‡†å¤‡æ‰“å­—æ•ˆæœ
      textElement.textContent = '';
      textElement.classList.remove('typing-complete');
      
      let index = 0;
      const typeSpeed = 30; // æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’ï¼‰
      
      function typeWriter() {
        if (index < content.length) {
          textElement.textContent += content.charAt(index);
          index++;
          setTimeout(typeWriter, typeSpeed);
        } else {
          // æ‰“å­—å®Œæˆåéšè—å…‰æ ‡ï¼ˆé€šè¿‡CSSæ§åˆ¶ï¼‰
          textElement.classList.add('typing-complete');
        }
      }
      
      // å»¶è¿Ÿå¼€å§‹æ‰“å­—æ•ˆæœ
      setTimeout(typeWriter, 800);
    });
  }

  // é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–
  function handlePageLoad() {
    setTimeout(initAITyping, 100);
  }

  // ç›‘å¬é¡µé¢å¯¼èˆªäº‹ä»¶ï¼ˆé€‚ç”¨äºAstroçš„å®¢æˆ·ç«¯è·¯ç”±ï¼‰
  function setupNavigationListeners() {
    // DOMContentLoadedäº‹ä»¶
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', handlePageLoad);
    } else {
      handlePageLoad();
    }

    // ç›‘å¬Astroçš„é¡µé¢å¯¼èˆªäº‹ä»¶
    document.addEventListener('astro:page-load', handlePageLoad);
    
    // ç›‘å¬æµè§ˆå™¨çš„popstateäº‹ä»¶ï¼ˆåé€€/å‰è¿›æŒ‰é’®ï¼‰
    window.addEventListener('popstate', handlePageLoad);
    
    // ç›‘å¬pushstateå’Œreplacestateäº‹ä»¶
    const originalPushState = history.pushState;
    const originalReplaceState = history.replaceState;
    
    history.pushState = function() {
      originalPushState.apply(history, arguments);
      setTimeout(handlePageLoad, 100);
    };
    
    history.replaceState = function() {
      originalReplaceState.apply(history, arguments);
      setTimeout(handlePageLoad, 100);
    };
  }

  // ç«‹å³è®¾ç½®ç›‘å¬å™¨
  setupNavigationListeners();
</script>